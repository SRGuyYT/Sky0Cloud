{
    email {$ACME_EMAIL}
}

# Explicitly listen on port 80 and 443 to align with Cloudflare Full (Strict)
http://sky0cloud.dpdns.org, https://sky0cloud.dpdns.org {
    
    # Global compression
    encode zstd gzip

    # Security Headers for that A+ rating
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Matrix .well-known (Federation & Discovery)
    handle /.well-known/matrix/* {
        root * /srv/well-known
        file_server
        header Access-Control-Allow-Origin "*"
        header Content-Type application/json
    }

    # API Traffic to Tuwunel (Matrix Core)
    # Using the container names from your cleaned docker-compose
    @matrix {
        path /_matrix/*
        path /_synapse/admin/*
    }
    handle @matrix {
        reverse_proxy sky0cloud-tuwunel:6167 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
        }
    }

    # Element Web UI (The Glassmorphism Client)
    handle {
        reverse_proxy sky0cloud-element:80
    }
}
